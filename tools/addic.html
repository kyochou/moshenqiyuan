<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é­”ç¥èµ·æº-æ¨å¹¿æµ·æŠ¥ç”Ÿæˆ</title>
    <script type="text/javascript" src="../statics/common.js"></script>
    <script type="text/javascript" src="../js/load_float_contact.js"></script>
    <link rel="stylesheet" type="text/css" href="../pc/css/dms005.css" />
    <link rel="stylesheet" type="text/css" href="../pc/css/content.css" />
    <style>
        body {
            background: #23241f url(../pc/images/bg-body.jpg) no-repeat center bottom;
            font-family: "Microsoft YaHei",Tahoma,SimSun,Verdana;
            font-size: 12px;
            color: #d7b591;
            margin: 0;
            padding: 0;
        } 

        /* ä¿®å¤æµ®åŠ¨ç»„ä»¶æ ·å¼ */
        #float_contact {
            position: fixed !important;
            z-index: 9999 !important;
        }

        .fixedbox {
            position: fixed !important;
            right: 10px !important;
            bottom: 30px !important;
            z-index: 9999 !important;
        }

        .container {
            background: rgba(31, 24, 11, 0.9);
            border: 1px solid #ac8946;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #ac8946;
            margin-bottom: 30px;
            text-shadow: 0 2px 3px rgba(0, 0, 0, .7);
        }

        .main-content {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            align-items: flex-start;
        }

        .left-panel {
            flex: 1;
            min-width: 0;
        }

        .right-panel {
            width: 400px;
            flex-shrink: 0;
        }

        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
            }

            .right-panel {
                width: 100%;
            }

            .promotion-instructions {
                position: static;
                margin-top: 20px;
            }
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #d7b591;
        }

        input, select {
            padding: 10px;
            border: 1px solid #ac8946;
            border-radius: 4px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.1);
            color: #d7b591;
        }

        input[type="file"] {
            border: none;
            padding: 0;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }

        button:hover {
            background: #8b7242;
        }

        .canvas-container {
            text-align: center;
            margin: 20px 0;
            border: 2px dashed #ac8946;
            padding: 20px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
        }

        canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid #ac8946;
            background: rgba(31, 24, 11, 0.8);
        }

        .download-section {
            text-align: center;
            margin-top: 20px;
        }

        .url-example {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #ac8946;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            color: #d7b591;
        }

        .color-picker {
            width: 100%;
            height: 40px;
        }

        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .phone-input {
            position: relative;
        }

        .phone-validation {
            font-size: 12px;
            margin-top: 5px;
            height: 16px;
        }

        .phone-valid {
            color: #28a745;
        }

        .phone-invalid {
            color: #dc3545;
        }

        input:invalid {
            border-color: #dc3545;
        }

        input:valid {
            border-color: #28a745;
        }

        .promotion-instructions {
            background: rgba(31, 24, 11, 0.8);
            border: 1px solid #ac8946;
            border-radius: 8px;
            padding: 20px;
            margin: 0;
            position: sticky;
            top: 20px;
        }

        .promotion-instructions h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #ac8946;
            font-size: 18px;
            border-bottom: 2px solid #ac8946;
            padding-bottom: 8px;
            text-shadow: 0 2px 3px rgba(0, 0, 0, .7);
        }

        .instruction-item {
            margin-bottom: 12px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            border-left: 4px solid #ac8946;
            line-height: 1.6;
            color: #d7b591;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .instruction-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }

        .instruction-item:last-child {
            margin-bottom: 0;
        }

        /* å¾®ä¿¡å·å±•ç¤ºæ ·å¼ */
        .wechat-contact {
            margin-top: 15px;
            padding: 15px;
            background: rgba(31, 24, 11, 0.8);
            border: 1px solid #ac8946;
            border-radius: 6px;
            border-left: 4px solid #28a745;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .wechat-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .wechat-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .wechat-item:last-child {
            margin-bottom: 0;
        }

        .wechat-label {
            font-weight: bold;
            color: #28a745;
            margin-right: 10px;
            min-width: 40px;
        }

        .wechat-id {
            color: #d7b591;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .wechat-qr {
            position: relative;
            display: inline-block;
        }

        .qr-float {
            position: absolute;
            top: -120px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .qr-float::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid white;
        }

        .qr-float img {
            width: 100px;
            height: 100px;
            border-radius: 4px;
        }

        .qr-float.visible {
            opacity: 1;
            visibility: visible;
        }

        /* æ¨å¹¿ç æ˜¾ç¤ºåŒºåŸŸæ ·å¼ */
        .promotion-code-section {
            background: rgba(31, 24, 11, 0.8);
            border: 1px solid #ac8946;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .promotion-code-label {
            font-size: 16px;
            font-weight: bold;
            color: #ac8946;
            margin-bottom: 15px;
        }

        .promotion-code-display {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #28a745;
            border-radius: 6px;
            padding: 15px 20px;
            font-family: 'Courier New', monospace;
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
            letter-spacing: 3px;
            margin: 15px 0;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .promotion-code-display:hover {
            border-color: #d7b591;
            color: #d7b591;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .copy-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .copy-button:hover {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .copy-button:active {
            transform: translateY(0);
        }

        .promotion-code-tips {
            font-size: 12px;
            color: #d7b591;
            margin-top: 10px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="news-container">
        <div class="news-header">
            <h1 class="news-title">é­”ç¥èµ·æº-ä¸“å±æ¨å¹¿æµ·æŠ¥ç”Ÿæˆ</h1>
            <div class="news-date">å‘å¸ƒæ—¶é—´ï¼š2025-10-15</div>
        </div>

        <div class="news-content">
            <div class="container">
                <!-- å®Œæ•´ç•Œé¢ -->
                <div id="fullInterface">

            <div id="status"></div>

            <div class="main-content">
                <!-- å·¦ä¾§æ“ä½œåŒºåŸŸ -->
                <div class="left-panel">
                    <div class="controls">
                        <div class="control-group phone-input">
                            <label for="phoneInput">è¯·è¾“å…¥æ‚¨çš„æ‰‹æœºå·ç (æ¸¸æˆè´¦å·):</label>
                            <input type="text" id="phoneInput" placeholder="è¾“å…¥æ‰‹æœºå·ç " maxlength="11" pattern="1[3-9]\d{9}">
                            <div id="phoneValidation" class="phone-validation"></div>
                        </div>
                    </div>

                    <div style="text-align: center;">
                        <button onclick="addTextToImage()">æ·»åŠ </button>
                        <button onclick="downloadImage()">ä¸‹è½½</button>
                    </div>

                    <!-- æ¨å¹¿ç æ˜¾ç¤ºåŒºåŸŸ -->
                    <div id="promotionCodeSection" class="promotion-code-section" style="display: none;">
                        <div class="promotion-code-label">æ‚¨çš„ä¸“å±æ¨å¹¿ç </div>
                        <div id="promotionCodeDisplay" class="promotion-code-display" onclick="selectCode()" title="ç‚¹å‡»é€‰æ‹©æ¨å¹¿ç "></div>
                        <button class="copy-button" onclick="manualCopyCode()">ğŸ“‹ å¤åˆ¶æ¨å¹¿ç </button>
                        <div class="promotion-code-tips">ç‚¹å‡»å¤åˆ¶æŒ‰é’®æˆ–ä½¿ç”¨ Ctrl+C å¤åˆ¶æ¨å¹¿ç </div>
                    </div>

                    <div class="canvas-container">
                        <canvas id="canvas"></canvas>
                    </div>
                </div>

                <!-- å³ä¾§æ¨å¹¿è¯´æ˜ -->
                <div class="right-panel">
                    <div class="promotion-instructions">
                        <h3>æ¨å¹¿è¯´æ˜</h3>
                        <div class="instruction-item">è¾“å…¥è‡ªå·±çš„æ¸¸æˆè´¦æˆ·ï¼ˆæ‰‹æœºå·ï¼‰ï¼Œç‚¹å‡»æ·»åŠ ï¼Œç”Ÿæˆå¸¦æœ‰æ‚¨ä¸“å±æ¨å¹¿ç çš„æµ·æŠ¥</div>
                        <div class="instruction-item">ç‚¹å‡»ä¸‹è½½ï¼Œä¿å­˜æµ·æŠ¥ï¼Œå°†æµ·æŠ¥åˆ†äº«ç»™æœ‹å‹æˆ–è½¬å‘è‡³æ¸¸æˆç±»ç¾¤èŠã€è®ºå›ã€è´´å§ç­‰</div>
                        <div class="instruction-item">æ–°ç©å®¶ç™»å½•æ¸¸æˆåï¼Œåœ¨æ–°æ‰‹æ‘NPCè¾“å…¥æ¨å¹¿ç å¯é¢†å–æ–°æ‰‹ç¤¼åŒ…</div>
                        <div class="instruction-item">ä½¿ç”¨æ‚¨çš„æ¨å¹¿ç è¿›å…¥æ¸¸æˆçš„ç©å®¶è´¦æˆ·ï¼Œå°†ç»‘å®šæ‚¨çš„æ¨å¹¿äººèº«ä»½ï¼Œç©å®¶è¶Šæ´»è·ƒï¼Œæ‚¨è·å¾—çš„å¥–åŠ±è¶Šä¸°åš</div>
                    </div>
                </div>
            </div>

            <div class="url-example" style="display: none;">
                <strong>å½“å‰URLå‚æ•°ç¤ºä¾‹:</strong><br>
                <div id="dynamicUrlExample">åŸºæœ¬å‚æ•°: ?text=Hello&fontSize=40&fontColor=ff0000&textX=100&textY=150&fontFamily=Arial&imageUrl=https://example.com/image.jpg</div><br>
                <strong>è‡ªåŠ¨ä¸‹è½½:</strong> åœ¨URLæœ«å°¾æ·»åŠ  &autoDownload=true å³å¯è‡ªåŠ¨ä¸‹è½½å¤„ç†åçš„å›¾ç‰‡
            </div>
        </div>

            <!-- ä»…å›¾ç‰‡ç•Œé¢ -->
            <div id="imageOnlyInterface" style="display: none;">
                <canvas id="canvasOnly" style="max-width: 100%; height: auto; display: block; margin: 0 auto;"></canvas>
            </div>
            </div>

            <div class="last-sentence" style="margin-top: 20px;">
                <p>
                    <em>æœŸå¾…ä¸æ‚¨çš„ç›¸è§!</em>
                </p>
                <p class="signature">
                    <strong>ã€Šé­”ç¥èµ·æºã€‹å¼€å‘ç»„</strong>
                </p>
            </div>
        </div>
    </div>

    <script>
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');
        let currentImage = null;

        // è§£æGETå‚æ•°
        function getUrlParameters() {
            const params = {};
            const urlParams = new URLSearchParams(window.location.search);

            for (const [key, value] of urlParams) {
                params[key] = value;
            }


            // åº”ç”¨å›ºå®šå‚æ•°ï¼ˆç”¨æˆ·ä¸å¯è°ƒæ•´ï¼‰
            params.fontSize = '28';
            params.fontColor = '242424';
            params.fontFamily = 'KaiTi';
            params.textX = '52';
            params.textY = '1350';
            params.imageUrl = 'a1.png';

            return params;
        }

        // è®¾ç½®å‚æ•°åˆ°è¡¨å•
        function setParametersToForm(params) {
            if (params.phone) document.getElementById('phoneInput').value = params.phone;

            // æ›´æ–°ç¤ºä¾‹URL
            updateUrlExample();
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="${type}">${message}</div>`;

            // 3ç§’åè‡ªåŠ¨æ¸…é™¤æ¶ˆæ¯
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }

        // éªŒè¯æ‰‹æœºå·å¹¶æ˜¾ç¤ºå®æ—¶åé¦ˆ
        function validatePhoneInput() {
            const phoneInput = document.getElementById('phoneInput');
            const phoneValidation = document.getElementById('phoneValidation');
            const phone = phoneInput.value;

            if (!phone) {
                phoneValidation.textContent = '';
                phoneValidation.className = 'phone-validation';
                phoneInput.style.borderColor = '#ddd';
                return false;
            }

            if (phone.length < 11) {
                phoneValidation.textContent = `è¯·è¾“å…¥11ä½æ‰‹æœºå·ç  (${phone.length}/11)`;
                phoneValidation.className = 'phone-validation phone-invalid';
                phoneInput.style.borderColor = '#dc3545';
                return false;
            }

            if (!/^1[3-9]\d{9}$/.test(phone)) {
                phoneValidation.textContent = 'æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·';
                phoneValidation.className = 'phone-validation phone-invalid';
                phoneInput.style.borderColor = '#dc3545';
                return false;
            }

            phoneValidation.textContent = 'æ‰‹æœºå·æ ¼å¼æ­£ç¡®';
            phoneValidation.className = 'phone-validation phone-valid';
            phoneInput.style.borderColor = '#28a745';
            return true;
        }

        // æ›´æ–°URLç¤ºä¾‹
        function updateUrlExample() {
            const phone = document.getElementById('phoneInput').value || '13800138000';

            // å›ºå®šå‚æ•°
            const fixedParams = {
                fontSize: '28',
                fontColor: '242424',
                fontFamily: 'KaiTi',
                textX: '52',
                textY: '1350',
                imageUrl: 'a1.png'
            };

            const params = new URLSearchParams();
            if (phone) params.set('phone', phone);

            // æ·»åŠ å›ºå®šå‚æ•°
            Object.entries(fixedParams).forEach(([key, value]) => {
                params.set(key, value);
            });

            const exampleUrl = `?${params.toString()}`;
            document.getElementById('dynamicUrlExample').textContent = exampleUrl;

            // åˆå§‹åŒ–æ—¶éšè—æ¨å¹¿ç æ˜¾ç¤ºåŒºåŸŸ
            displayPromotionCode('');
        }

        // åŠ è½½å›¾ç‰‡
        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();

                // å¤„ç†è·¨åŸŸå›¾ç‰‡
                img.crossOrigin = 'anonymous';

                img.onload = function() {
                    currentImage = img;

                    // è®¾ç½®ç”»å¸ƒå¤§å°
                    canvas.width = img.width;
                    canvas.height = img.height;

                    // ç»˜åˆ¶å›¾ç‰‡
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);

                    resolve(img);
                };

                img.onerror = function(error) {
                    showStatus('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡URLæˆ–æ–‡ä»¶', 'error');
                    reject(error);
                };

                img.src = src;
            });
        }

        // æ·»åŠ æ–‡å­—åˆ°å›¾ç‰‡ï¼ˆä½¿ç”¨å›ºå®šå‚æ•°ï¼‰
        async function addTextToImage() {
            try {
                const phone = document.getElementById('phoneInput').value;

                if (!phone) {
                    showStatus('è¯·è¾“å…¥æ‰‹æœºå·ç ', 'error');
                    return;
                }

                // ä½¿ç”¨å›ºå®šå›¾ç‰‡URL
                const imageSrc = '../statics/activities/a1.png';

                // åŠ è½½å›¾ç‰‡
                await loadImage(imageSrc);

                if (!currentImage) {
                    showStatus('å›¾ç‰‡åŠ è½½å¤±è´¥', 'error');
                    return;
                }

                // ä½¿ç”¨å›ºå®šå‚æ•°
                const fontSize = '28';
                const fontColor = '#242424';
                const fontFamily = 'KaiTi';
                const textX = 52;
                const textY = 1350;

                // ä½¿ç”¨encodePhoneå¤„ç†æ‰‹æœºå·
                const encodedPhone = encodePhone(phone);

                // è®¾ç½®æ–‡å­—æ ·å¼
                ctx.font = `${fontSize}px ${fontFamily}`;
                ctx.fillStyle = fontColor;
                ctx.textBaseline = 'top';

                // æ·»åŠ æ–‡å­—é˜´å½±æ•ˆæœ
                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                ctx.shadowBlur = 2;
                ctx.shadowOffsetX = 1;
                ctx.shadowOffsetY = 1;

                // ç»˜åˆ¶æ–‡å­—
                ctx.fillText(encodedPhone, textX, textY);

                // é‡ç½®é˜´å½±
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;

                        // æ˜¾ç¤ºæ¨å¹¿ç åœ¨ç•Œé¢ä¸Š
                displayPromotionCode(encodedPhone);

                showStatus('æ·»åŠ æˆåŠŸï¼æ¨å¹¿ç : ' + encodedPhone, 'success');
                return Promise.resolve(); // è¿”å›Promiseä»¥ä¾¿é“¾å¼è°ƒç”¨

            } catch (error) {
                console.error('æ·»åŠ å¤±è´¥:', error);
                showStatus('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
                return Promise.reject(error);
            }
        }
        // ä¸‹è½½å›¾ç‰‡
        function downloadImage() {
            if (!currentImage) {
                showStatus('è¯·å…ˆæ·»åŠ æ¨å¹¿ç åˆ°å›¾ç‰‡', 'error');
                return;
            }

            // éªŒè¯æ‰‹æœºå·æ˜¯å¦å·²è¾“å…¥
            const phone = document.getElementById('phoneInput').value;
            if (!phone) {
                showStatus('è¯·è¾“å…¥æ‰‹æœºå·ç æ‰èƒ½ä¸‹è½½å›¾ç‰‡ï¼', 'error');
                // èšç„¦åˆ°æ‰‹æœºå·è¾“å…¥æ¡†
                document.getElementById('phoneInput').focus();
                return;
            }

            // éªŒè¯æ‰‹æœºå·æ ¼å¼
            if (!/^1[3-9]\d{9}$/.test(phone)) {
                showStatus('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç æ ¼å¼ï¼', 'error');
                document.getElementById('phoneInput').focus();
                return;
            }

            canvas.toBlob(function(blob) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;

                // è·å–æ‰‹æœºå·å†…å®¹å¹¶è¿›è¡Œç¼–ç å¤„ç†ä½œä¸ºæ–‡ä»¶å
                const phone = document.getElementById('phoneInput').value;
                const encodedPhone = phone ? encodePhone(phone) : null;
                let filename = encodedPhone ? `${encodedPhone}.png` : 'image-with-phone.png';

                // æ¸…ç†æ–‡ä»¶åï¼Œç§»é™¤ä¸å®‰å…¨çš„å­—ç¬¦
                filename = filename.replace(/[<>:"/\\|?*]/g, '').replace(/\s+/g, '_');

                // å¦‚æœæ–‡ä»¶åä¸ºç©ºæˆ–åªæœ‰ç‰¹æ®Šå­—ç¬¦ï¼Œä½¿ç”¨é»˜è®¤åç§°
                if (filename === '.png' || filename.length === 0) {
                    filename = 'image-with-phone.png';
                }

                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showStatus('å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼', 'success');
            }, 'image/png');
        }

        // å¤åˆ¶æ¨å¹¿ç åˆ°å‰ªè´´æ¿
        function copyPromotionCode(promotionCode) {
            if (!promotionCode) {
                console.warn('æ¨å¹¿ç ä¸ºç©ºï¼Œæ— æ³•å¤åˆ¶');
                return;
            }

            // ä½¿ç”¨ç°ä»£æµè§ˆå™¨çš„ Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(promotionCode).then(function() {
                    console.log('æ¨å¹¿ç å¤åˆ¶æˆåŠŸ:', promotionCode);
                }).catch(function(err) {
                    console.error('å¤åˆ¶å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•:', err);
                    fallbackCopyTextToClipboard(promotionCode);
                });
            } else {
                // å¤‡ç”¨æ–¹æ³•ï¼Œå…¼å®¹æ—§æµè§ˆå™¨
                fallbackCopyTextToClipboard(promotionCode);
            }
        }

        // å¤‡ç”¨å¤åˆ¶æ–¹æ³•
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;

            // è®¾ç½®æ ·å¼ä½¿å…¶ä¸å¯è§
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            textArea.style.opacity = '0';
            textArea.style.pointerEvents = 'none';

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    console.log('æ¨å¹¿ç å¤åˆ¶æˆåŠŸ (å¤‡ç”¨æ–¹æ³•):', text);
                } else {
                    console.error('å¤åˆ¶å¤±è´¥ (å¤‡ç”¨æ–¹æ³•)');
                }
            } catch (err) {
                console.error('å¤åˆ¶é”™è¯¯:', err);
                // å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
            }

            document.body.removeChild(textArea);
        }

        // æ˜¾ç¤ºæ¨å¹¿ç åœ¨ç•Œé¢ä¸Š
        function displayPromotionCode(promotionCode) {
            const section = document.getElementById('promotionCodeSection');
            const display = document.getElementById('promotionCodeDisplay');

            if (promotionCode) {
                display.textContent = promotionCode;
                section.style.display = 'block';

                // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                display.style.animation = 'pulse 0.5s ease-in-out';
                setTimeout(() => {
                    display.style.animation = '';
                }, 500);
            } else {
                section.style.display = 'none';
                display.textContent = '';
            }
        }

        // é€‰æ‹©æ¨å¹¿ç æ–‡æœ¬
        function selectCode() {
            const display = document.getElementById('promotionCodeDisplay');
            const promotionCode = display.textContent;

            if (!promotionCode) {
                return;
            }

            // åˆ›å»ºé€‰æ‹©èŒƒå›´
            const range = document.createRange();
            range.selectNodeContents(display);

            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);

            // æ·»åŠ è§†è§‰åé¦ˆ
            display.style.backgroundColor = 'rgba(40, 167, 69, 0.2)';
            setTimeout(() => {
                display.style.backgroundColor = '';
            }, 200);
        }

        // æ‰‹åŠ¨å¤åˆ¶æ¨å¹¿ç 
        function manualCopyCode() {
            const display = document.getElementById('promotionCodeDisplay');
            const promotionCode = display.textContent;

            if (!promotionCode) {
                showStatus('è¯·å…ˆç”Ÿæˆæ¨å¹¿ç ', 'error');
                return;
            }

            copyPromotionCode(promotionCode);
            showStatus('æ¨å¹¿ç å·²å¤åˆ¶: ' + promotionCode, 'success');

            // æ·»åŠ æŒ‰é’®åŠ¨ç”»åé¦ˆ
            const button = event.target;
            button.style.transform = 'scale(0.95)';
            setTimeout(() => {
                button.style.transform = '';
            }, 100);
        }

        // æ·»åŠ CSSåŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
        `;
        document.head.appendChild(style);

        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨åˆ°è¡¨å•å…ƒç´ 
        function addFormEventListeners() {
            // ç›‘å¬æ‰‹æœºå·è¾“å…¥æ¡†
            const phoneInput = document.getElementById('phoneInput');
            if (phoneInput) {
                phoneInput.addEventListener('input', function() {
                    validatePhoneInput();
                    updateUrlExample();
                });
                phoneInput.addEventListener('change', function() {
                    validatePhoneInput();
                    updateUrlExample();
                });
                phoneInput.addEventListener('blur', validatePhoneInput);
            }
        }

        // å¾®ä¿¡äºŒç»´ç æ˜¾ç¤º/éšè—åŠŸèƒ½
        let wechatTimers = {};

        function showWechatQR(id) {
            const element = document.getElementById(id);
            if (element) {
                // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„å®šæ—¶å™¨
                if (wechatTimers[id]) {
                    clearTimeout(wechatTimers[id]);
                }

                // æ˜¾ç¤ºäºŒç»´ç 
                element.classList.add('visible');
            }
        }

        function hideWechatQR(id) {
            // å»¶è¿Ÿéšè—ï¼Œè®©ç”¨æˆ·æœ‰æ—¶é—´ç§»åŠ¨åˆ°äºŒç»´ç ä¸Š
            wechatTimers[id] = setTimeout(() => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.remove('visible');
                }
            }, 200);
        }

        // ä¿æŒäºŒç»´ç æ˜¾ç¤ºå½“é¼ æ ‡åœ¨äºŒç»´ç ä¸Šæ—¶
        document.addEventListener('DOMContentLoaded', function() {
            const qrFloats = document.querySelectorAll('.qr-float');
            qrFloats.forEach(qr => {
                qr.addEventListener('mouseenter', function() {
                    const id = this.id;
                    if (wechatTimers[id]) {
                        clearTimeout(wechatTimers[id]);
                    }
                    this.classList.add('visible');
                });

                qr.addEventListener('mouseleave', function() {
                    this.classList.remove('visible');
                });
            });
        });

        // é¡µé¢åŠ è½½æ—¶å¤„ç†URLå‚æ•°
        window.addEventListener('load', function() {
            const params = getUrlParameters();

            if (Object.keys(params).length > 0) {
                setParametersToForm(params);

                // è‡ªåŠ¨åŠ è½½å›ºå®šå›¾ç‰‡
                setTimeout(() => {
                    loadImage('../statics/activities/a1.png');
                }, 500);

                // å¦‚æœæœ‰æ‰‹æœºå·ï¼Œè‡ªåŠ¨æ·»åŠ 
                if (params.phone) {
                    setTimeout(() => {
                        addTextToImage().then(() => {
                            // å¦‚æœè®¾ç½®äº†è‡ªåŠ¨ä¸‹è½½å‚æ•°ï¼Œåˆ™è‡ªåŠ¨ä¸‹è½½
                            if (params.autoDownload === 'true' || params.autoDownload === '1') {
                                setTimeout(() => {
                                    downloadImage();
                                    showStatus('æ­£åœ¨è‡ªåŠ¨ä¸‹è½½...', 'success');
                                }, 500);
                            }
                        });
                    }, 1500);
                }
            }

            // è®¾ç½®é»˜è®¤ç”»å¸ƒå¤§å°
            canvas.width = 800;
            canvas.height = 600;

            // æ·»åŠ è¡¨å•äº‹ä»¶ç›‘å¬å™¨
            addFormEventListeners();

            // åˆå§‹åŒ–ç¤ºä¾‹URL
            updateUrlExample();
        });

        // æ”¯æŒæ‹–æ‹½ä¸Šä¼ å›¾ç‰‡
        canvas.addEventListener('dragover', function(e) {
            e.preventDefault();
            canvas.style.opacity = '0.7';
        });

        canvas.addEventListener('dragleave', function(e) {
            e.preventDefault();
            canvas.style.opacity = '1';
        });

        canvas.addEventListener('drop', function(e) {
            e.preventDefault();
            canvas.style.opacity = '1';

            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    loadImage(e.target.result);
                };
                reader.readAsDataURL(files[0]);
            }
        });
    </script>
</body>
</html>